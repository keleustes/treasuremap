---
apiVersion: armada.airshipit.org/v1alpha1
kind: ArmadaChart
metadata:
  labels:
    name: ucp-maas-type
  layeringDefinition:
    abstract: false
    actions:
    - method: merge
      path: .values.manifests
    - method: merge
      path: .values.network
    - method: merge
      path: .values.conf
    - method: replace
      path: .values.dependencies.static
    - method: replace
      path: .values.endpoints.maas_ingress.hosts
    layer: type
    parentSelector:
      name: ucp-maas-global
  name: ucp-maas
  substitutions:
  - dest:
      path: .values.conf.drydock.bootaction_url
      pattern: (DRYDOCK_IP)
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .bootstrap.ip
  - dest:
      path: .values.conf.drydock.bootaction_url
      pattern: (DRYDOCK_PORT)
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .node_ports.drydock_api
  - dest:
      path: .values.conf.maas.url.maas_url
      pattern: (MAAS_IP)
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .bootstrap.ip
  - dest:
      path: .values.conf.maas.url.maas_url
      pattern: (MAAS_PORT)
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .node_ports.maas_api
  - dest:
      path: .values.endpoints.maas_region.port.region_api.nodeport
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .node_ports.maas_api
  - dest:
      path: .values.endpoints.maas_region.port.region_proxy.default
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .node_ports.maas_proxy
spec:
  values:
    conf:
      drydock:
        bootaction_url: http://DRYDOCK_IP:DRYDOCK_PORT/api/v1.0
      maas:
        credentials:
          secret:
            namespace: ucp
        images:
          default_image: xenial
          default_kernel: ga-16.04
          default_os: ubuntu
        url:
          maas_url: http://MAAS_IP:MAAS_PORT/MAAS
    dependencies:
      static:
        bootstrap_admin_user:
          jobs:
          - maas-db-sync
          services:
          - endpoint: internal
            service: maas_region
          - endpoint: internal
            service: maas_db
        db_init:
          services:
          - endpoint: internal
            service: maas_db
        db_sync:
          jobs:
          - maas-db-init
        export_api_key:
          jobs:
          - maas-bootstrap-admin-user
          services:
          - endpoint: internal
            service: maas_region
          - endpoint: internal
            service: maas_db
        import_resources:
          jobs:
          - maas-bootstrap-admin-user
          services:
          - endpoint: internal
            service: maas_region
          - endpoint: internal
            service: maas_db
        maas_ingress: {}
        rack_controller:
          jobs:
          - maas-export-api-key
          services:
          - endpoint: internal
            service: maas_region
        region_controller:
          jobs:
          - maas-db-sync
          services:
          - endpoint: internal
            service: maas_db
    endpoints:
      maas_ingress:
        hosts:
          default: maas-ingress
          error_pages: maas-ingress-error
    manifests:
      maas_ingress: false
    network:
      region_api:
        ingress:
          public: false
        node_port:
          enabled: true
      region_proxy:
        node_port:
          enabled: true
