---
apiVersion: armada.airshipit.org/v1alpha1
kind: ArmadaChart
metadata:
  layeringDefinition:
    abstract: false
    actions:
    - method: replace
      path: .
    layer: site
    parentSelector:
      name: kubernetes-calico-global
  name: kubernetes-calico
  replacement: true
  substitutions:
  - dest:
      path: .source
    src:
      kind: PeglegSoftwareVersions
      name: software-versions
      path: .charts.kubernetes.calico.calico
  - dest:
      path: .values.images.tags
    src:
      kind: PeglegSoftwareVersions
      name: software-versions
      path: .images.calico.calico
  - dest:
      path: .values.endpoints.etcd.host_fqdn_override.default
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .calico.etcd.service_ip
  - dest:
      path: .values.networking.podSubnet
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .kubernetes.pod_cidr
  - dest:
      path: .values.conf.controllers.K8S_API
      pattern: SUB_KUBERNETES_IP
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .kubernetes.api_service_ip
  - dest:
      path: .values.conf.node.IP_AUTODETECTION_METHOD
    src:
      kind: PeglegCommonAddresses
      name: common-addresses
      path: .calico.ip_autodetection_method
  - dest:
      path: .values.endpoints.etcd.auth.client.tls.ca
    src:
      kind: DeckhandCertificateAuthority
      name: calico-etcd
      path: .
  - dest:
      path: .values.endpoints.etcd.auth.client.tls.crt
    src:
      kind: DeckhandCertificate
      name: calico-node
      path: .
  - dest:
      path: .values.endpoints.etcd.auth.client.tls.key
    src:
      kind: DeckhandCertificateKey
      name: calico-node
      path: .
spec:
  chart_name: calico
  dependencies:
  - calico-htk
  namespace: kube-system
  protected:
    continue_processing: true
  release: kubernetes-calico
  upgrade:
    no_hooks: false
    pre:
      delete:
      - labels:
          release_group: airship-kubernetes-calico
        type: job
  values:
    conf:
      cni_network_config:
        cniVersion: 0.3.0
        name: k8s-pod-network
        plugins:
        - etcd_ca_cert_file: /etc/calico/pki/ca
          etcd_cert_file: /etc/calico/pki/crt
          etcd_endpoints: __ETCD_ENDPOINTS__
          etcd_key_file: /etc/calico/pki/key
          ipam:
            type: calico-ipam
          kubernetes:
            kubeconfig: __KUBECONFIG_FILEPATH__
          log_level: info
          mtu: 1500
          policy:
            type: k8s
          type: calico
        - capabilities:
            portMappings: true
          snat: true
          type: portmap
      controllers:
        K8S_API: https://SUB_KUBERNETES_IP:443
      node:
        CALICO_STARTUP_LOGLEVEL: INFO
        CLUSTER_TYPE: k8s,bgp
        ETCD_CA_CERT_FILE: /etc/calico/pki/ca
        ETCD_CERT_FILE: /etc/calico/pki/crt
        ETCD_KEY_FILE: /etc/calico/pki/key
        WAIT_FOR_STORAGE: 'true'
    endpoints:
      etcd:
        hosts:
          default: calico-etcd
        scheme:
          default: https
    manifests:
      daemonset_calico_etcd: false
      job_image_repo_sync: false
      pod_calicoctl: false
      service_calico_etcd: false
    networking:
      settings:
        ippool:
          disabled: 'false'
          ipip:
            enabled: 'true'
            mode: Always
          nat_outgoing: 'true'
        mesh: 'on'
  wait:
    labels:
      release_group: airship-kubernetes-calico
    timeout: 1800
